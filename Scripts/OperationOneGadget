local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local pingId = {
    Drone = "rbxassetid://95428092249797",
    Camera = "rbxassetid://70956972762553"
}

local pingColor = {
    Drone = Color3.fromRGB(0, 100, 200),
    Camera = Color3.fromRGB(150, 150, 150)
}

local EspTable = {
    Drone = {
        Enabled = false,
        Connections = {},
        PingObjects = {}
    },
    Camera = {
        Enabled = false,
        Connections = {},
        PingObjects = {}
    }
}

local function createPingObject(gadgetType, parent, model)
    local pingModule = ReplicatedStorage.Modules.Effects.PingObject
    if not pingModule then return end
    
    local pingClone = pingModule:Clone()
    pingClone.Parent = parent
    
    pingClone.Adornee = model
    pingClone.Enabled = true
    
    pingClone.Frame.BackgroundColor3 = pingColor[gadgetType]
    pingClone.Arrow.ImageColor3 = pingColor[gadgetType]
    pingClone.Frame.ImageLabel.Image = pingId[gadgetType]
    
    return pingClone
end

local function setupDroneESP()
    for _, drone in ipairs(Workspace:GetChildren()) do
        if drone.Name == "Drone" and drone:IsA("Model") then
            if not EspTable.Drone.PingObjects[drone] then
                local ping = createPingObject("Drone", Workspace.CurrentCamera, drone)
                if ping then
                    EspTable.Drone.PingObjects[drone] = ping
                end
            end
        end
    end
end

local function setupCameraESP()
    for _, model in ipairs(Workspace:GetChildren()) do
        if model:IsA("Model") then
            local folder = model:FindFirstChildWhichIsA("Folder")
            if folder then
                local defaultCameras = folder:FindFirstChild("DefaultCameras")
                if defaultCameras then
                    for _, cameraModel in ipairs(defaultCameras:GetChildren()) do
                        if cameraModel:IsA("Model") then
                            if not EspTable.Camera.PingObjects[cameraModel] then
                                local ping = createPingObject("Camera", Workspace.CurrentCamera, cameraModel)
                                if ping then
                                    EspTable.Camera.PingObjects[cameraModel] = ping
                                    local camPart = cameraModel:FindFirstChild("Cam")
                                    if camPart and ping:FindFirstChild("testname") then
                                        ping.testname = camPart
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

local function cleanupPings(pingTable)
    for model, ping in pairs(pingTable) do
        if ping and ping.Parent then
            ping:Destroy()
        end
    end
    pingTable = {}
end

EspTable.Drone.Connections.childAdded = Workspace.ChildAdded:Connect(function(child)
    if EspTable.Drone.Enabled and child.Name == "Drone" and child:IsA("Model") then
        local ping = createPingObject("Drone", Workspace.CurrentCamera, child)
        if ping then
            EspTable.Drone.PingObjects[child] = ping
        end
    end
end)

EspTable.Drone.Connections.childRemoved = Workspace.ChildRemoved:Connect(function(child)
    if EspTable.Drone.PingObjects[child] then
        local ping = EspTable.Drone.PingObjects[child]
        if ping and ping.Parent then
            ping:Destroy()
        end
        EspTable.Drone.PingObjects[child] = nil
    end
end)

EspTable.Camera.Connections.childAdded = Workspace.ChildAdded:Connect(function(child)
    if EspTable.Camera.Enabled and child:IsA("Model") then
        task.wait(0.1)
        setupCameraESP()
    end
end)

EspTable.Camera.Connections.childRemoved = Workspace.ChildRemoved:Connect(function(child)
    if EspTable.Camera.PingObjects[child] then
        local ping = EspTable.Camera.PingObjects[child]
        if ping and ping.Parent then
            ping:Destroy()
        end
        EspTable.Camera.PingObjects[child] = nil
    end
end)

local function updateESP(gadgetType, state)
    EspTable[gadgetType].Enabled = state
    
    if state then
        if gadgetType == "Drone" then
            setupDroneESP()
        elseif gadgetType == "Camera" then
            setupCameraESP()
        end
    else
        cleanupPings(EspTable[gadgetType].PingObjects)
    end
end

local Esp = {
    Drone = {
        getEnabled = function()
            return EspTable.Drone.Enabled
        end,
        setEnabled = function(state)
            updateESP("Drone", state)
        end
    },
    Camera = {
        getEnabled = function()
            return EspTable.Camera.Enabled
        end,
        setEnabled = function(state)
            updateESP("Camera", state)
        end
    }
}

local DroneMetaTable = {}
local CameraMetaTable = {}

DroneMetaTable.__index = function(self, key)
    if key == "Enabled" then
        return EspTable.Drone.Enabled
    end
    return Esp.Drone[key]
end

DroneMetaTable.__newindex = function(self, key, value)
    if key == "Enabled" then
        updateESP("Drone", value)
    else
        rawset(self, key, value)
    end
end

CameraMetaTable.__index = function(self, key)
    if key == "Enabled" then
        return EspTable.Camera.Enabled
    end
    return Esp.Camera[key]
end

CameraMetaTable.__newindex = function(self, key, value)
    if key == "Enabled" then
        updateESP("Camera", value)
    else
        rawset(self, key, value)
    end
end

setmetatable(Esp.Drone, DroneMetaTable)
setmetatable(Esp.Camera, CameraMetaTable)

return Esp
